import telebot
from docx import Document
from docx.shared import Inches, Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
import json
from datetime import datetime
import os

# Replace with your bot token from BotFather
BOT_TOKEN = "8446187652:AAGrbhECI6XGUcNwQU0ulYM-DTjWo9AFvUo"
bot = telebot.TeleBot(BOT_TOKEN)

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "Welcome! Use the menu button to open the Property Listing form.")

@bot.message_handler(content_types=['web_app_data'])
def handle_web_app_data(message):
    try:
        # Parse the JSON data from mini app
        data = json.loads(message.web_app_data.data)
        
        # Create Word document
        doc = Document()
        
        # Title
        title = doc.add_heading('PROPERTY LISTING REPORT', 0)
        title.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        # Timestamp
        timestamp_para = doc.add_paragraph()
        timestamp_run = timestamp_para.add_run(f"Generated: {datetime.now().strftime('%d %B %Y at %H:%M')}")
        timestamp_run.italic = True
        timestamp_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        doc.add_paragraph()
        doc.add_paragraph('_' * 70)
        doc.add_paragraph()
        
        # SELLER SECTION
        doc.add_heading('SELLER INFORMATION', level=1)
        
        seller_table = doc.add_table(rows=5, cols=2)
        seller_table.style = 'Light Grid Accent 1'
        
        client = data['client']
        seller_data = [
            ('Full Name', client.get('fullName', 'N/A')),
            ('Email', client.get('email') or 'Not provided'),
            ('Phone Number', client.get('phone', 'N/A')),
            ('Preferred Contact', client.get('preferredContactMethod') or 'Not specified'),
            ('Notes', client.get('additionalNotes') or 'None')
        ]
        
        for i, (label, value) in enumerate(seller_data):
            row = seller_table.rows[i]
            row.cells[0].text = label
            row.cells[0].paragraphs[0].runs[0].font.bold = True
            row.cells[1].text = str(value)
        
        doc.add_paragraph()
        doc.add_paragraph('_' * 70)
        doc.add_paragraph()
        
        # PROPERTY SECTION
        doc.add_heading('PROPERTY DETAILS', level=1)
        
        listing = data['listing']
        
        # Address
        address_para = doc.add_paragraph()
        address_run = address_para.add_run(f"üìç {listing.get('propertyAddress', 'N/A')}")
        address_run.font.size = Pt(14)
        address_run.font.bold = True
        
        # Property Type
        doc.add_paragraph(f"Property Type: {listing.get('propertyType', 'N/A')}")
        
        # ASKING PRICE - prominent
        price_para = doc.add_paragraph()
        price_run = price_para.add_run(f"ASKING PRICE: {listing.get('askingPrice', 'N/A')}")
        price_run.bold = True
        price_run.font.size = Pt(18)
        price_run.font.color.rgb = RGBColor(0, 112, 192)
        
        doc.add_paragraph()
        
        # Property Specifications Table
        doc.add_heading('Specifications', level=2)
        spec_table = doc.add_table(rows=6, cols=2)
        spec_table.style = 'Light Grid Accent 1'
        
        specs = [
            ('Bedrooms', listing.get('bedrooms', 'N/A')),
            ('Bathrooms', listing.get('bathrooms', 'N/A')),
            ('Garages', listing.get('garages', 'N/A') or 'None'),
            ('Floor Area', f"{listing.get('squareFeet', 'N/A')} m¬≤" if listing.get('squareFeet') else 'N/A'),
            ('Erf Size', f"{listing.get('erfSize', 'N/A')} m¬≤" if listing.get('erfSize') else 'N/A'),
            ('Year Built', listing.get('yearBuilt', 'N/A') or 'N/A')
        ]
        
        for i, (label, value) in enumerate(specs):
            row = spec_table.rows[i]
            row.cells[0].text = label
            row.cells[0].paragraphs[0].runs[0].font.bold = True
            row.cells[1].text = str(value)
        
        doc.add_paragraph()
        
        # Additional Rooms
        additional_rooms = listing.get('additionalRooms', [])
        if additional_rooms and len(additional_rooms) > 0:
            doc.add_heading('Additional Rooms', level=2)
            rooms_text = ', '.join([room.replace('_', ' ').replace('Room', ' Room').title() for room in additional_rooms])
            doc.add_paragraph(rooms_text)
            doc.add_paragraph()
        
        # Key Features
        if listing.get('features'):
            doc.add_heading('Key Features', level=2)
            doc.add_paragraph(listing['features'])
            doc.add_paragraph()
        
        # Description
        if listing.get('description'):
            doc.add_heading('Property Description', level=2)
            doc.add_paragraph(listing['description'])
            doc.add_paragraph()
        
        # Viewing Information
        if listing.get('showingDate'):
            doc.add_heading('Viewing Information', level=2)
            viewing_para = doc.add_paragraph()
            viewing_para.add_run(f"üìÖ Date: {listing['showingDate']}")
            if listing.get('showingTime'):
                doc.add_paragraph(f"üïê Time: {listing['showingTime']}")
            doc.add_paragraph()
        
        # Footer
        doc.add_paragraph()
        doc.add_paragraph('_' * 70)
        footer_para = doc.add_paragraph()
        footer_run = footer_para.add_run(f"\nSubmitted by: {data['agentInfo'].get('first_name', 'Agent')} {data['agentInfo'].get('last_name', '')}")
        footer_run.italic = True
        footer_run.font.size = Pt(9)
        
        timestamp_footer = doc.add_paragraph()
        timestamp_footer_run = timestamp_footer.add_run(f"Submission Time: {data.get('timestamp', 'N/A')}")
        timestamp_footer_run.italic = True
        timestamp_footer_run.font.size = Pt(9)
        
        # Save document
        safe_name = client.get('fullName', 'Unknown').replace(' ', '_')
        filename = f"listing_{safe_name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.docx"
        doc.save(filename)
        
        # Send document to agent
        with open(filename, 'rb') as doc_file:
            bot.send_document(
                message.chat.id, 
                doc_file,
                caption=f"‚úÖ Property listing report generated!\n\nüìã Property: {listing.get('propertyAddress', 'N/A')}\nüë§ Seller: {client.get('fullName', 'N/A')}"
            )
        
        # Delete local file after sending
        os.remove(filename)
        
        # Confirmation message
        bot.send_message(
            message.chat.id,
            "‚úÖ Listing successfully processed and document generated!",
            parse_mode='Markdown'
        )
        
    except Exception as e:
        bot.reply_to(message, f"‚ùå Error processing listing: {str(e)}")
        print(f"Error: {e}")

if __name__ == '__main__':
    print("Bot is running...")
    bot.infinity_polling()
